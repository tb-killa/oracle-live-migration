name: 🧱 Build Rocky Migration Live ISO

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # täglich 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
      options: --privileged

    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4

    - name: 📁 Verzeichnis-Struktur prüfen
      run: |
        echo "=== Repository-Struktur ==="
        find overlay -type f | sort || true
        chmod +x overlay/usr/local/bin/migration-gui.sh || true

    - name: 💾 Restore ISO Cache
      uses: actions/cache@v4
      id: cache_iso
      with:
        path: .cache/iso
        key: rocky9-kde-live

    - name: 🌐 Lade Rocky 9 KDE ISO (falls kein Cache)
      if: steps.cache_iso.outputs.cache-hit != 'true'
      run: |
        set -e
        mkdir -p .cache/iso
        cd .cache/iso
        echo "📦 Lade Rocky Linux 9 KDE Live ISO..."
        dnf -y install wget
        wget -q --show-progress https://dl.rockylinux.org/pub/rocky/9/live/x86_64/Rocky-9-KDE-x86_64-latest.iso -O Rocky-9-KDE-x86_64-latest.iso
        echo "✅ ISO heruntergeladen."

    - name: 🔍 Preflight Check
      run: |
        set -e
        if [ ! -f .cache/iso/Rocky-9-KDE-x86_64-latest.iso ]; then
          echo "❌ ISO fehlt – Abbruch"
          exit 1
        fi
        echo "✅ ISO vorhanden und wird verwendet."

    - name: 📦 DNF vorbereiten
      uses: actions/cache@v4
      id: cache_dnf
      with:
        path: /var/cache/dnf
        key: rocky9-dnf-cache

    - name: 🔧 Installiere Tools für ISO-Build
      run: |
        set -e
        dnf -y install epel-release
        dnf -y install p7zip p7zip-plugins xorriso genisoimage rsync tar zip unzip \
          virt-v2v libguestfs-tools qemu-kvm virt-install dmraid mdadm lvm2 \
          ntfs-3g smartmontools btrfs-progs xfsprogs lsscsi parted dialog whiptail \
          glibc-langpack-de kbd nfs-utils systemd-udev net-tools iproute
        echo "✅ Alle Tools installiert."

    - name: 🚀 Starte ISO-Build
      run: |
        set -euo pipefail
        WORKDIR="migration-live"
        SRC_ISO=".cache/iso/Rocky-9-KDE-x86_64-latest.iso"
        mkdir -p "$WORKDIR/custom_iso"
        echo "=== Entpacke Rocky ISO ==="
        7z x -y -o"$WORKDIR/custom_iso" "$SRC_ISO" || echo "⚠️ Warnungen beim Entpacken möglich."

        echo "=== Prüfe Bootdateien ==="
        for f in isolinux/isolinux.bin isolinux/boot.cat images/efiboot.img; do
          [ -f "$WORKDIR/custom_iso/$f" ] && echo "✅ Gefunden: $f" || echo "⚠️ Fehlend: $f"
        done

        echo "=== Locale & System konfigurieren ==="
        mkdir -p "$WORKDIR/custom_iso/etc"
        echo "LANG=de_DE.UTF-8" > "$WORKDIR/custom_iso/etc/locale.conf"
        echo "KEYMAP=de" > "$WORKDIR/custom_iso/etc/vconsole.conf"
        ln -sf /usr/share/zoneinfo/Europe/Berlin "$WORKDIR/custom_iso/etc/localtime"

        echo "=== Overlay anwenden ==="
        rsync -a overlay/ "$WORKDIR/custom_iso/"

        echo "=== Chroot-Integration: Pakete & RAID-Unterstützung ==="
        mount --bind /dev "$WORKDIR/custom_iso/dev"
        mount --bind /proc "$WORKDIR/custom_iso/proc"
        mount --bind /sys "$WORKDIR/custom_iso/sys"
        dnf -y --installroot="$WORKDIR/custom_iso" install dmraid mdadm lvm2 virt-v2v qemu-kvm dialog whiptail glibc-langpack-de kbd || true
        umount -l "$WORKDIR/custom_iso/dev" "$WORKDIR/custom_iso/proc" "$WORKDIR/custom_iso/sys" || true

        echo "=== Erzeuge Hybrid-ISO (UEFI + BIOS) ==="
        xorriso -as mkisofs \
          -iso-level 3 -volid "Rocky-Migration-Live" \
          -eltorito-boot isolinux/isolinux.bin -no-emul-boot -boot-load-size 4 -boot-info-table \
          -eltorito-alt-boot -e images/efiboot.img -no-emul-boot -isohybrid-gpt-basdat \
          -output "$WORKDIR/oracle-migration-live.iso" "$WORKDIR/custom_iso"

        echo "✅ ISO erzeugt:"
        ls -lh "$WORKDIR/oracle-migration-live.iso"

    - name: 🧪 Teste ISO mit QEMU (Smoke Test)
      run: |
        set -e
        echo "=== Teste ISO-Bootfähigkeit ==="
        qemu-system-x86_64 -m 1024 -cdrom migration-live/oracle-migration-live.iso -boot d -no-reboot -display none -serial stdio -snapshot -monitor none -no-shutdown &
        sleep 25
        echo "✅ Smoke-Test abgeschlossen (QEMU gestartet & beendet)."

    - name: 📦 Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: oracle-migration-live.iso
        path: migration-live/oracle-migration-live.iso

    - name: 🧾 Systeminfo sammeln
      run: |
        mkdir -p migration-live/buildinfo
        uname -a > migration-live/buildinfo/uname.txt
        cat /etc/os-release > migration-live/buildinfo/os-release.txt
        dnf --version > migration-live/buildinfo/dnf-version.txt
        dnf repolist > migration-live/buildinfo/dnf-repolist.txt
        echo "✅ Buildinfos gesammelt."

    - name: 📦 Buildinfos hochladen
      uses: actions/upload-artifact@v4
      with:
        name: buildinfo
        path: migration-live/buildinfo/
