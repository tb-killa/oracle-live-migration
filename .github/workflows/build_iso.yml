name: Build Oracle Migration Live ISO

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # täglicher Build um 02:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: oraclelinux:9

    steps:
      # ----------------------------------------------------------
      # 🧩 Repository prüfen
      # ----------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Preflight Check
        run: |
          echo "=== Repository Struktur prüfen ==="
          test -f build_migration_iso.sh && echo "✅ build_migration_iso.sh gefunden"
          chmod +x build_migration_iso.sh || true
          chmod +x overlay/usr/local/bin/migration-gui.sh || true

      # ----------------------------------------------------------
      # 🧱 Cache für ISO & DNF
      # ----------------------------------------------------------
      - name: Cache Oracle ISO
        id: cache-iso
        uses: actions/cache@v4
        with:
          path: migration-live/OracleLinux-R9-U3-x86_64-dvd.iso
          key: oraclelinux9u3-dvd-cache

      - name: Cache DNF Packages
        id: cache-dnf
        uses: actions/cache@v4
        with:
          path: /var/cache/dnf
          key: dnf-cache-${{ runner.os }}-${{ hashFiles('**/build_migration_iso.sh') }}

      # ----------------------------------------------------------
      # 🔽 ISO nur herunterladen, wenn Cache fehlt
      # ----------------------------------------------------------
      - name: Download Oracle Linux 9 ISO (nur bei Bedarf)
        if: steps.cache-iso.outputs.cache-hit != 'true'
        run: |
          mkdir -p migration-live
          echo "🔧 Installiere wget..."
          dnf -y install wget
          echo "📦 Lade Oracle Linux 9 ISO (ca. 9 GB)..."
          wget --progress=dot:giga -O migration-live/OracleLinux-R9-U3-x86_64-dvd.iso \
            https://yum.oracle.com/ISOS/OracleLinux/OL9/u3/x86_64/OracleLinux-R9-U3-x86_64-dvd.iso
          echo "✅ Download abgeschlossen."
          echo "📏 Prüfe Dateigröße..."
          size=$(stat -c%s migration-live/OracleLinux-R9-U3-x86_64-dvd.iso)
          echo "Größe: $size Bytes"
          if [ "$size" -lt 1000000000 ]; then
            echo "❌ ISO scheint ungültig (zu klein) – Abbruch."
            exit 1
          fi
          echo "✅ ISO gültig (>1 GB)."

      # ----------------------------------------------------------
      # ⚙️ Build-Abhängigkeiten
      # ----------------------------------------------------------
      - name: Install build dependencies
        run: |
          dnf -y install oracle-epel-release-el9
          dnf -y update
          dnf -y install \
            p7zip p7zip-plugins rsync wget xorriso mkisofs bsdtar \
            diffutils coreutils util-linux zip tar unzip \
            libisofs libisoburn libburn

      # ----------------------------------------------------------
      # 🧰 ISO-Build
      # ----------------------------------------------------------
      - name: Build Migration ISO
        run: |
          echo "🚀 Starte ISO-Build..."
          bash ./build_migration_iso.sh || { echo "❌ Build fehlgeschlagen – siehe Log"; exit 1; }

      # ----------------------------------------------------------
      # 📤 Artefakte hochladen
      # ----------------------------------------------------------
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: oracle-migration-live
          path: |
            migration-live/oracle-migration-live.iso
            migration-live/new_pkgs.txt
