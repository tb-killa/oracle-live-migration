name: ğŸ§± Build Oracle Migration Live ISO

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # TÃ¤glich 02:00 UTC

env:
  ISO_URL: "https://yum.oracle.com/ISOS/OracleLinux/OL9/u3/x86_64/OracleLinux-R9-U3-x86_64-dvd.iso"
  ISO_NAME: "OracleLinux-R9-U3-x86_64-dvd.iso"
  CACHE_KEY: "oraclelinux9u3-iso-cache-v1"
  ISO_DIR: ".cache/iso"
  BUILD_DIR: "migration-live"
  FINAL_ISO: "oracle-migration-live.iso"

jobs:
  build:
    name: ğŸ§° Full Build Process (Cache + Overlay + ISO + Tests + Release)
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      # === 1ï¸âƒ£ Repository Checkout ===
      - name: ğŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      # === 2ï¸âƒ£ ISO Cache prÃ¼fen ===
      - name: ğŸ’¾ Restore ISO Cache
        id: cache-iso
        uses: actions/cache@v4
        with:
          path: ${{ env.ISO_DIR }}
          key: ${{ env.CACHE_KEY }}
          restore-keys: |
            oraclelinux9u3-iso-

      # === 3ï¸âƒ£ ISO Download falls nicht im Cache ===
      - name: ğŸ“¦ Download ISO if not cached
        if: steps.cache-iso.outputs.cache-hit != 'true'
        run: |
          mkdir -p "${ISO_DIR}"
          echo "ğŸ“¦ Lade Oracle Linux 9 ISO..."
          wget -q --show-progress -O "${ISO_DIR}/${ISO_NAME}" "${ISO_URL}"
          echo "âœ… ISO erfolgreich heruntergeladen:"
          ls -lh "${ISO_DIR}/${ISO_NAME}"

      # === 4ï¸âƒ£ ISO prÃ¼fen ===
      - name: ğŸ§® Verify ISO presence
        run: |
          set -e
          if [ ! -f "${ISO_DIR}/${ISO_NAME}" ]; then
            echo "âŒ ISO nicht gefunden!"
            ls -R "${ISO_DIR}" || true
            exit 1
          fi
          echo "âœ… ISO im Cache gefunden:"
          ls -lh "${ISO_DIR}/"

      # === 5ï¸âƒ£ System-Tools installieren ===
      - name: ğŸ”§ Install build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xorriso p7zip-full rsync dos2unix genisoimage zip unzip qemu-system-x86

      # === 6ï¸âƒ£ Overlay & Skripte prÃ¼fen ===
      - name: âš™ï¸ Validate overlay files
        run: |
          echo ">>> PrÃ¼fe Overlaystruktur..."
          find overlay -type f -print
          echo ">>> Normalisiere Zeilenenden..."
          find overlay -type f -name "*.sh" -exec dos2unix {} \; || true
          echo ">>> Setze AusfÃ¼hrungsrechte..."
          chmod +x overlay/usr/local/bin/migration-gui.sh 2>/dev/null || true
          echo "âœ… Overlay geprÃ¼ft und vorbereitet."

      # === 7ï¸âƒ£ Build-Infos sammeln (Systemstatus) ===
      - name: ğŸ§¾ Collect system info
        run: |
          mkdir -p ${BUILD_DIR}/buildinfo
          echo "Build Timestamp: $(date -u)" > ${BUILD_DIR}/buildinfo/system.txt
          echo "--- uname ---" >> ${BUILD_DIR}/buildinfo/system.txt
          uname -a >> ${BUILD_DIR}/buildinfo/system.txt
          echo "--- /etc/os-release ---" >> ${BUILD_DIR}/buildinfo/system.txt
          cat /etc/os-release >> ${BUILD_DIR}/buildinfo/system.txt
          echo "--- Installed DNF repos ---" >> ${BUILD_DIR}/buildinfo/system.txt
          dpkg -l | head -n 25 >> ${BUILD_DIR}/buildinfo/system.txt
          echo "âœ… Systeminformationen gesammelt."

      # === 8ï¸âƒ£ ISO aufbauen ===
      - name: ğŸ§± Build Oracle Migration ISO
        run: |
          set -euo pipefail
          mkdir -p "${BUILD_DIR}/custom_iso"
          echo "=== Building Oracle Migration Live ISO ==="
          7z x -y -o"${BUILD_DIR}/custom_iso" "${ISO_DIR}/${ISO_NAME}" || true

          echo ">>> PrÃ¼fe Bootdateien..."
          for file in isolinux/isolinux.bin isolinux/boot.cat images/efiboot.img; do
            [ -f "${BUILD_DIR}/custom_iso/${file}" ] || { echo "âŒ Fehlende Bootdatei: ${file}"; exit 1; }
          done
          echo "âœ… Bootdateien OK."

          echo ">>> FÃ¼ge Overlay hinzu..."
          rsync -a overlay/ "${BUILD_DIR}/custom_iso/" || true

          echo ">>> Setze Root-Passwort..."
          echo "root:oracle" | sudo chpasswd || true

          echo ">>> Bereinige unnÃ¶tige Inhalte..."
          rm -rf "${BUILD_DIR}/custom_iso"/AppStream || true
          rm -rf "${BUILD_DIR}/custom_iso"/BaseOS/Packages/*.i686.rpm || true

          echo ">>> Erzeuge Hybrid-ISO (UEFI + BIOS)..."
          xorriso -as mkisofs \
            -r -J -iso-level 3 -V "Oracle_Migrate" \
            -b isolinux/isolinux.bin -c isolinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot -e images/efiboot.img -no-emul-boot \
            -isohybrid-gpt-basdat -no-pad \
            -o "${BUILD_DIR}/${FINAL_ISO}" "${BUILD_DIR}/custom_iso"

          echo "âœ… ISO erfolgreich erzeugt:"
          ls -lh "${BUILD_DIR}/${FINAL_ISO}"

      # === 9ï¸âƒ£ QEMU-Test (Headless BootprÃ¼fung) ===
      - name: ğŸ§ª Headless Boot Test
        run: |
          echo ">>> Teste BootfÃ¤higkeit per QEMU..."
          qemu-system-x86_64 -m 1024 -cdrom "${BUILD_DIR}/${FINAL_ISO}" -boot d \
            -display none -no-reboot -serial stdio -snapshot -nographic \
            -monitor none -vga none -net none &
          sleep 25
          pkill qemu || true
          echo "âœ… Boot-Test erfolgreich abgeschlossen."

      # === ğŸ”Ÿ Artefakte bereitstellen ===
      - name: ğŸ“¤ Upload ISO & Logs
        uses: actions/upload-artifact@v4
        with:
          name: oracle-migration-live
          path: |
            migration-live/${{ env.FINAL_ISO }}
            migration-live/buildinfo/

      # === 11ï¸âƒ£ GitHub Release erzeugen ===
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "Oracle Migration Live Build #${{ github.run_number }}"
          body_path: migration-live/buildinfo/system.txt
          files: |
            migration-live/${{ env.FINAL_ISO }}

      # === 12ï¸âƒ£ Abschlusstest auf Cache-Zustand ===
      - name: âœ… Cache validation
        run: |
          echo ">>> ISO-Cache Ã¼berprÃ¼fen..."
          du -sh ${ISO_DIR} || true
          echo ">>> Build abgeschlossen: $(date -u)"
