name: Build Oracle Migration Live ISO

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # tÃ¤glicher Build um 02:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: oraclelinux:9

    steps:
      # ----------------------------------------------------------
      # ğŸ§© Repository prÃ¼fen
      # ----------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Preflight Check
        run: |
          echo "=== Repository Struktur prÃ¼fen ==="
          test -f build_migration_iso.sh && echo "âœ… build_migration_iso.sh gefunden"
          chmod +x build_migration_iso.sh || true
          chmod +x overlay/usr/local/bin/migration-gui.sh || true

      # ----------------------------------------------------------
      # ğŸ§± Cache fÃ¼r ISO & DNF
      # ----------------------------------------------------------
      - name: Cache Oracle ISO
        id: cache-iso
        uses: actions/cache@v4
        with:
          path: migration-live/OracleLinux-R9-U3-x86_64-dvd.iso
          key: oraclelinux9u3-dvd-cache

      - name: Cache DNF Packages
        id: cache-dnf
        uses: actions/cache@v4
        with:
          path: /var/cache/dnf
          key: dnf-cache-${{ runner.os }}-${{ hashFiles('**/build_migration_iso.sh') }}

      # ----------------------------------------------------------
      # ğŸ”½ ISO nur herunterladen, wenn Cache fehlt
      # ----------------------------------------------------------
      - name: Download Oracle Linux 9 ISO (nur bei Bedarf)
        if: steps.cache-iso.outputs.cache-hit != 'true'
        run: |
          mkdir -p migration-live
          echo "ğŸ”§ Installiere wget..."
          dnf -y install wget
          echo "ğŸ“¦ Lade Oracle Linux 9 ISO (ca. 9 GB)..."
          wget --progress=dot:giga -O migration-live/OracleLinux-R9-U3-x86_64-dvd.iso \
            https://yum.oracle.com/ISOS/OracleLinux/OL9/u3/x86_64/OracleLinux-R9-U3-x86_64-dvd.iso
          echo "âœ… Download abgeschlossen."
          echo "ğŸ“ PrÃ¼fe DateigrÃ¶ÃŸe..."
          size=$(stat -c%s migration-live/OracleLinux-R9-U3-x86_64-dvd.iso)
          echo "GrÃ¶ÃŸe: $size Bytes"
          if [ "$size" -lt 1000000000 ]; then
            echo "âŒ ISO scheint ungÃ¼ltig (zu klein) â€“ Abbruch."
            exit 1
          fi
          echo "âœ… ISO gÃ¼ltig (>1 GB)."

      # ----------------------------------------------------------
      # âš™ï¸ Build-AbhÃ¤ngigkeiten
      # ----------------------------------------------------------
      - name: Install build dependencies
        run: |
          dnf -y install oracle-epel-release-el9
          dnf -y update
          dnf -y install \
            p7zip p7zip-plugins rsync wget xorriso mkisofs bsdtar \
            diffutils coreutils util-linux zip tar unzip \
            libisofs libisoburn libburn

      # ----------------------------------------------------------
      # ğŸ§° ISO-Build
      # ----------------------------------------------------------
      - name: Build Migration ISO
        run: |
          echo "ğŸš€ Starte ISO-Build..."
          bash ./build_migration_iso.sh || { echo "âŒ Build fehlgeschlagen â€“ siehe Log"; exit 1; }

      # ----------------------------------------------------------
      # ğŸ“¤ Artefakte hochladen
      # ----------------------------------------------------------
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: oracle-migration-live
          path: |
            migration-live/oracle-migration-live.iso
            migration-live/new_pkgs.txt
