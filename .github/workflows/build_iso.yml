name: üß± Build Rocky Linux 9.6 Live Migration ISO (Phase 4.4)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-live-iso:
    runs-on: ubuntu-latest
    steps:
      # --------------------------------------------------------------
      - name: üß∞ Checkout Repository
        uses: actions/checkout@v4

      # --------------------------------------------------------------
      - name: ‚öôÔ∏è Install Build Tools (Ubuntu 24.04-kompatibel)
        run: |
          set -e
          echo "üß© Entferne defekte Microsoft-Repos..."
          sudo find /etc/apt/sources.list.d -type f -name "*.list" \
            -exec sudo sed -i '/packages.microsoft.com/d' {} \; || true
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list || true
          echo "üì¶ Aktualisiere Paketquellen..."
          sudo apt-get update -y
          echo "üîß Installiere ben√∂tigte Tools..."
          sudo apt-get install -y p7zip-full xorriso genisoimage syslinux-utils wget jq
          echo "‚úÖ Build-Tools bereit."

      # --------------------------------------------------------------
      - name: üíæ Restore ISO Cache
        id: cache-iso
        uses: actions/cache@v4
        with:
          path: .cache/iso
          key: rocky9-mate-live-iso-v4

      # --------------------------------------------------------------
      - name: üì¶ Download Rocky 9.6 MATE Live ISO (if not cached)
        if: steps.cache-iso.outputs.cache-hit != 'true'
        run: |
          set -e
          mkdir -p .cache/iso
          cd .cache/iso
          echo "üì• Lade Rocky 9.6 MATE Live-ISO..."
          wget -q --show-progress \
            https://dl.rockylinux.org/vault/rocky/9.6/live/x86_64/Rocky-9-MATE-x86_64-latest.iso \
            -O Rocky-9-MATE-x86_64-latest.iso
          echo "‚úÖ Download abgeschlossen"
          ls -lh

      # --------------------------------------------------------------
      - name: üß© Extract ISO
        run: |
          set -e
          mkdir -p migration-live/custom_iso
          7z x .cache/iso/Rocky-9-MATE-x86_64-latest.iso \
             -o"migration-live/custom_iso" -y
          echo "=== Beispielhafte Inhalte ==="
          ls -lh migration-live/custom_iso | head -n 15

      # --------------------------------------------------------------
      - name: üîß Integrate RAID + Migration Tools
        run: |
          cat << 'EOF' > migration-live/custom_iso/auto_raid_setup.sh
          #!/bin/bash
          echo "üîß Initialisiere RAID- und Migrationstools..." | tee /var/log/livecheck.log
          dnf install -y kernel-modules-extra mdadm dmraid lvm2 virt-v2v virt-install virt-manager \
              --setopt=install_weak_deps=False --skip-broken
          for mod in isci dm_mod md_mod raid0 raid1 raid10 raid456 multipath; do
              modprobe $mod 2>/dev/null || echo "‚ùå Modul $mod fehlt" >> /var/log/livecheck.log
          done
          dmraid -ay >> /var/log/livecheck.log 2>&1
          mdadm --assemble --scan >> /var/log/livecheck.log 2>&1
          vgchange -ay >> /var/log/livecheck.log 2>&1
          lsblk >> /var/log/livecheck.log
          echo "‚úÖ RAID-Pr√ºfung abgeschlossen." >> /var/log/livecheck.log
          EOF
          chmod +x migration-live/custom_iso/auto_raid_setup.sh

      # --------------------------------------------------------------
      - name: üåç Set Locale & Keyboard (DE)
        run: |
          cat << 'EOF' > migration-live/custom_iso/locale_setup.sh
          #!/bin/bash
          echo "üåç Setze Sprache & Tastatur auf Deutsch..." | tee -a /var/log/livecheck.log
          localectl set-locale LANG=de_DE.UTF-8
          localectl set-keymap de
          timedatectl set-timezone Europe/Berlin
          EOF
          chmod +x migration-live/custom_iso/locale_setup.sh

      # --------------------------------------------------------------
      - name: üñ•Ô∏è Add Desktop Info Files
        run: |
          mkdir -p migration-live/custom_iso/root/Desktop/System-Tools
          echo "RAID aktivieren:\n  sudo /auto_raid_setup.sh" \
            > migration-live/custom_iso/root/Desktop/System-Tools/RAID-Check.txt
          echo "OLVM-Zertifikat importieren:\n  sudo update-ca-trust extract" \
            > migration-live/custom_iso/root/Desktop/System-Tools/CA-Import.txt
          echo "Virt-V2V-Migration starten:\n  virt-v2v -i disk /dev/sda -o qemu -os /mnt/target" \
            > migration-live/custom_iso/root/Desktop/System-Tools/Migration.txt
          echo "Sprache & Tastatur umstellen:\n  sudo /locale_setup.sh" \
            > migration-live/custom_iso/root/Desktop/System-Tools/Sprache.txt

      # --------------------------------------------------------------
      - name: üß± Build Bootable ISO (UEFI + BIOS)
        run: |
          set -e
          xorriso -as mkisofs -r -V "Rocky9-Live-Migration" \
            -o migration-live/rocky9-live-migration.iso \
            -J -joliet-long \
            -b isolinux/isolinux.bin -c isolinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot -e images/efiboot.img -no-emul-boot \
            -isohybrid-gpt-basdat \
            migration-live/custom_iso

      # --------------------------------------------------------------
      - name: üîç Validate Bootstruktur (xorriso Safe)
        run: |
          set -e
          echo "=== Pr√ºfe ISO-Bootstruktur ==="
          xorriso -indev migration-live/rocky9-live-migration.iso -report_el_torito plain \
            | grep -E "boot image|Platform Id|System area summary"
          echo "=== Test-Mount (Lesbarkeit) ==="
          mkdir -p /tmp/testiso
          sudo mount -o loop migration-live/rocky9-live-migration.iso /tmp/testiso
          ls /tmp/testiso | head
          sudo umount /tmp/testiso
          echo "‚úÖ ISO erfolgreich gepr√ºft."

      # --------------------------------------------------------------
      - name: üíæ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocky9-live-migration.iso
          path: migration-live/rocky9-live-migration.iso
