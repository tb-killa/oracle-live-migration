name: üß± Build Rocky Linux 9.6 Live Migration ISO (Phase 4.2)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-live-iso:
    runs-on: ubuntu-latest
    steps:
      # --------------------------------------------------------------
      - name: üß∞ Checkout Repository
        uses: actions/checkout@v4

      # --------------------------------------------------------------
      - name: ‚öôÔ∏è Install Build Tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y p7zip-full xorriso genisoimage syslinux-utils \
              wget jq isoinfo

      # --------------------------------------------------------------
      - name: üíæ Restore ISO Cache
        id: cache-iso
        uses: actions/cache@v4
        with:
          path: .cache/iso
          key: rocky9-mate-live-iso-v1

      # --------------------------------------------------------------
      - name: üì¶ Download Rocky 9.6 MATE Live ISO (if not cached)
        if: steps.cache-iso.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache/iso
          cd .cache/iso
          echo "üì• Lade Rocky 9.6 MATE Live ISO herunter..."
          wget -q --show-progress \
            https://dl.rockylinux.org/vault/rocky/9.6/live/x86_64/Rocky-9-MATE-x86_64-latest.iso \
            -O Rocky-9-MATE-x86_64-latest.iso
          echo "‚úÖ Download abgeschlossen"
          ls -lh

      # --------------------------------------------------------------
      - name: üß© Extract ISO
        run: |
          mkdir -p migration-live/custom_iso
          7z x .cache/iso/Rocky-9-MATE-x86_64-latest.iso \
            -o"migration-live/custom_iso" -y
          echo "=== Beispielhafte Inhalte ==="
          ls -lh migration-live/custom_iso | head -n 20

      # --------------------------------------------------------------
      - name: üîß Integrate RAID + Migration Tools
        run: |
          cat << 'EOF' > migration-live/custom_iso/auto_raid_setup.sh
          #!/bin/bash
          echo "üîß Initialisiere RAID- und Migrationstools..." | tee /var/log/livecheck.log
          dnf install -y kernel-modules-extra mdadm dmraid lvm2 virt-v2v virt-install virt-manager \
              --setopt=install_weak_deps=False --skip-broken
          for mod in isci dm_mod md_mod raid0 raid1 raid10 raid456 multipath; do
              modprobe $mod 2>/dev/null || echo "‚ùå Modul $mod fehlt" >> /var/log/livecheck.log
          done
          dmraid -ay >> /var/log/livecheck.log 2>&1
          mdadm --assemble --scan >> /var/log/livecheck.log 2>&1
          vgchange -ay >> /var/log/livecheck.log 2>&1
          lsblk >> /var/log/livecheck.log
          echo "‚úÖ RAID-Pr√ºfung abgeschlossen." >> /var/log/livecheck.log
          EOF
          chmod +x migration-live/custom_iso/auto_raid_setup.sh

      # --------------------------------------------------------------
      - name: üåç Set Locale & Keyboard (DE)
        run: |
          cat << 'EOF' > migration-live/custom_iso/locale_setup.sh
          #!/bin/bash
          echo "üåç Setze Sprache & Tastatur auf Deutsch..." | tee -a /var/log/livecheck.log
          localectl set-locale LANG=de_DE.UTF-8
          localectl set-keymap de
          timedatectl set-timezone Europe/Berlin
          EOF
          chmod +x migration-live/custom_iso/locale_setup.sh

      # --------------------------------------------------------------
      - name: üñ•Ô∏è Add Desktop Info Files
        run: |
          mkdir -p migration-live/custom_iso/root/Desktop/System-Tools
          cat << 'TXT' > migration-live/custom_iso/root/Desktop/System-Tools/RAID-Check.txt
          RAID aktivieren:
            sudo /auto_raid_setup.sh
          TXT
          cat << 'TXT' > migration-live/custom_iso/root/Desktop/System-Tools/CA-Import.txt
          OLVM-Zertifikat importieren:
            sudo update-ca-trust extract
          TXT
          cat << 'TXT' > migration-live/custom_iso/root/Desktop/System-Tools/Migration.txt
          Virt-V2V-Migration starten:
            virt-v2v -i disk /dev/sda -o qemu -os /mnt/target
          TXT
          cat << 'TXT' > migration-live/custom_iso/root/Desktop/System-Tools/Sprache.txt
          Sprache & Tastatur umstellen:
            sudo /locale_setup.sh
          TXT

      # --------------------------------------------------------------
      - name: üß± Build Bootable ISO (UEFI + BIOS)
        run: |
          xorriso -as mkisofs -r -V "Rocky9-Live-Migration" \
            -o migration-live/rocky9-live-migration.iso \
            -J -joliet-long \
            -b isolinux/isolinux.bin -c isolinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -eltorito-alt-boot -e images/efiboot.img -no-emul-boot \
            -isohybrid-gpt-basdat \
            migration-live/custom_iso

      # --------------------------------------------------------------
      - name: üîç Validate Boot Structure (Headless Safe)
        run: |
          echo "=== Pr√ºfe ISO Bootstruktur ==="
          BOOT_REPORT=$(isoinfo -d -i migration-live/rocky9-live-migration.iso)
          echo "$BOOT_REPORT" | grep -E "System id|Boot catalog|Eltorito"
          echo "$BOOT_REPORT" | grep -q "Eltorito" \
            && echo "‚úÖ El-Torito Bootstruktur erkannt" \
            || (echo "‚ùå Keine Bootstruktur gefunden" && exit 1)

          echo "=== Pr√ºfe EFI-Bootbereich ===" 
          7z l migration-live/rocky9-live-migration.iso | grep -q "efiboot.img" \
            && echo "‚úÖ EFI Bootbereich vorhanden" \
            || (echo "‚ùå Kein EFI Bootbereich" && exit 1)

          echo "=== Test-Mount (Lesbarkeit) ==="
          mkdir -p /tmp/testiso
          sudo mount -o loop migration-live/rocky9-live-migration.iso /tmp/testiso
          ls /tmp/testiso | head
          sudo umount /tmp/testiso
          echo "‚úÖ ISO erfolgreich gemountet und gepr√ºft"

      # --------------------------------------------------------------
      - name: üíæ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocky9-live-migration.iso
          path: migration-live/rocky9-live-migration.iso
